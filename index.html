<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Weather Dashboard</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 900px; margin: 20px auto; padding: 20px; }
    h1, h2 { color: #333; }
    input, textarea, button { padding: 8px; margin: 5px 0; font-size: 14px; }
    input, textarea { width: 100%; box-sizing: border-box; }
    button { cursor: pointer; margin-right: 5px; }
    .weather-card { border: 1px solid #ddd; padding: 15px; margin: 10px 0; border-radius: 5px; background: #f9f9f9; }
    .search-box { margin: 20px 0; padding: 15px; background: #f0f0f0; border-radius: 5px; }
    .modal { display: none; position: fixed; z-index: 1; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); }
    .modal-content { background: white; margin: 5% auto; padding: 20px; width: 80%; max-width: 500px; border-radius: 5px; }
    .close { float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
  </style>
</head>
<body>
  <h1>Weather Dashboard</h1>
  
  <!-- Search Box -->
  <div class="search-box">
    <h2>Search</h2>
    <input type="text" id="searchStation" placeholder="Search by station name...">
    <input type="date" id="searchDate">
    <button onclick="searchWeather()">Search</button>
    <button onclick="clearSearch()">Clear</button>
  </div>

  <!-- Add Button -->
  <button onclick="openAddModal()">Add New Record</button>

  <!-- Statistics -->
  <h2>Statistics</h2>
  <div id="stats"></div>

  <!-- Weather Records -->
  <h2>Weather Records</h2>
  <button onclick="fetchWeather()">Refresh</button>
  <div id="weatherList"></div>

  <!-- Modal -->
  <div id="modal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeModal()">&times;</span>
      <h2 id="modalTitle">Add Weather Record</h2>
      <form id="weatherForm">
        <input type="hidden" id="recordId">
        <input type="text" id="station" placeholder="Station Name" required>
        <input type="datetime-local" id="recordedAt" required>
        <input type="number" id="temperature" placeholder="Temperature (°C)" step="0.1">
        <input type="number" id="humidity" placeholder="Humidity (%)">
        <input type="number" id="pressure" placeholder="Pressure (hPa)">
        <input type="number" id="windSpeed" placeholder="Wind Speed (km/h)">
        <input type="text" id="windDirection" placeholder="Wind Direction">
        <textarea id="notes" placeholder="Notes" rows="3"></textarea>
        <button type="submit">Save</button>
        <button type="button" onclick="closeModal()">Cancel</button>
      </form>
    </div>
  </div>

  <script>
    const API_URL = 'https://weather-api-kuyakim.vercel.app/api/v1/weather';
    let allWeatherData = [];

    // Fetch all weather records
    async function fetchWeather() {
      try {
        const response = await fetch(API_URL + '?limit=50');
        allWeatherData = await response.json();
        displayWeather(allWeatherData);
      } catch (error) {
        console.error('Error:', error);
      }
    }

    // Display weather records
    function displayWeather(data) {
      const weatherList = document.getElementById('weatherList');
      if (data.length === 0) {
        weatherList.innerHTML = '<p>No records found.</p>';
        return;
      }
      weatherList.innerHTML = data.map(w => `
        <div class="weather-card">
          <h3>${w.station || 'Unknown Station'}</h3>
          <p><strong>Date:</strong> ${new Date(w.recordedAt).toLocaleString()}</p>
          <p><strong>Temperature:</strong> ${w.temperature}°C | <strong>Humidity:</strong> ${w.humidity}%</p>
          <p><strong>Pressure:</strong> ${w.pressure} hPa | <strong>Wind:</strong> ${w.windSpeed} km/h ${w.windDirection || ''}</p>
          <p><strong>Notes:</strong> ${w.notes || 'N/A'}</p>
          <button onclick='editWeather(${JSON.stringify(w)})'>Edit</button>
          <button onclick="deleteWeather('${w._id}')">Delete</button>
        </div>
      `).join('');
    }

    // Fetch statistics
    async function fetchStats() {
      try {
        const response = await fetch(API_URL + '/stats');
        const stats = await response.json();
        document.getElementById('stats').innerHTML = `
          <div class="weather-card">
            <p><strong>Total:</strong> ${stats.count} | <strong>Avg Temp:</strong> ${stats.avgTemp?.toFixed(1)}°C | 
            <strong>Avg Humidity:</strong> ${stats.avgHumidity?.toFixed(1)}% | <strong>Min:</strong> ${stats.minTemp}°C | 
            <strong>Max:</strong> ${stats.maxTemp}°C</p>
          </div>
        `;
      } catch (error) {
        console.error('Error:', error);
      }
    }

    // Search weather
    function searchWeather() {
      const searchTerm = document.getElementById('searchStation').value.toLowerCase();
      const searchDate = document.getElementById('searchDate').value;
      
      let filtered = allWeatherData;
      
      if (searchTerm) {
        filtered = filtered.filter(w => 
          (w.station || '').toLowerCase().includes(searchTerm)
        );
      }
      
      if (searchDate) {
        filtered = filtered.filter(w => {
          const recordDate = new Date(w.recordedAt).toISOString().split('T')[0];
          return recordDate === searchDate;
        });
      }
      
      displayWeather(filtered);
    }

    // Clear search
    function clearSearch() {
      document.getElementById('searchStation').value = '';
      document.getElementById('searchDate').value = '';
      displayWeather(allWeatherData);
    }

    // Open add modal
    function openAddModal() {
      document.getElementById('modalTitle').textContent = 'Add Weather Record';
      document.getElementById('weatherForm').reset();
      document.getElementById('recordId').value = '';
      document.getElementById('modal').style.display = 'block';
    }

    // Edit weather
    function editWeather(weather) {
      document.getElementById('modalTitle').textContent = 'Edit Weather Record';
      document.getElementById('recordId').value = weather._id;
      document.getElementById('station').value = weather.station || '';
      document.getElementById('recordedAt').value = new Date(weather.recordedAt).toISOString().slice(0, 16);
      document.getElementById('temperature').value = weather.temperature || '';
      document.getElementById('humidity').value = weather.humidity || '';
      document.getElementById('pressure').value = weather.pressure || '';
      document.getElementById('windSpeed').value = weather.windSpeed || '';
      document.getElementById('windDirection').value = weather.windDirection || '';
      document.getElementById('notes').value = weather.notes || '';
      document.getElementById('modal').style.display = 'block';
    }

    // Close modal
    function closeModal() {
      document.getElementById('modal').style.display = 'none';
    }

    // Submit form
    document.getElementById('weatherForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const recordId = document.getElementById('recordId').value;
      const weatherData = {
        station: document.getElementById('station').value,
        recordedAt: new Date(document.getElementById('recordedAt').value).toISOString(),
        temperature: parseFloat(document.getElementById('temperature').value) || null,
        humidity: parseFloat(document.getElementById('humidity').value) || null,
        pressure: parseFloat(document.getElementById('pressure').value) || null,
        windSpeed: parseFloat(document.getElementById('windSpeed').value) || null,
        windDirection: document.getElementById('windDirection').value,
        notes: document.getElementById('notes').value
      };

      try {
        const url = recordId ? `${API_URL}/${recordId}` : API_URL;
        const method = recordId ? 'PUT' : 'POST';
        
        const response = await fetch(url, {
          method: method,
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(weatherData)
        });

        if (response.ok) {
          alert(recordId ? 'Record updated!' : 'Record added!');
          closeModal();
          fetchWeather();
          fetchStats();
        }
      } catch (error) {
        console.error('Error:', error);
      }
    });

    // Delete weather
    async function deleteWeather(id) {
      if (!confirm('Delete this record?')) return;
      
      try {
        await fetch(`${API_URL}/${id}`, { method: 'DELETE' });
        fetchWeather();
        fetchStats();
      } catch (error) {
        console.error('Error:', error);
      }
    }

    // Close modal when clicking outside
    window.onclick = function(event) {
      const modal = document.getElementById('modal');
      if (event.target == modal) closeModal();
    }

    // Load data
    fetchWeather();
    fetchStats();
  </script>
</body>
</html>